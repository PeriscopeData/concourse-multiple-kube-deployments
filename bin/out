#!/bin/bash
set -e
set -o pipefail
exec 3>&1 # use fd 3 for script output
exec 1>&2 # send normal stdout to stderr for logging

echo "Starting out"

payload="$(mktemp "$TMPDIR/k8s-resource-request.XXXXXX")"
cat > "$payload" <&0

DRY_RUN=$(jq -r .params.dry_run < "$payload")
if [[ "$DRY_RUN" == "true" ]]; then
    echo "********************** Running in DRY_RUN mode **********************"
fi

rollback() {
    DEPLOYMENT=$1
    DRY_RUN=$2
    [ -n "$DEPLOYMENT" ] || exit 1
    echo "Running: $KUBECTL rollout undo deployment/$DEPLOYMENT"
    if [[ "$DRY_RUN" == "null" ]] || [[ "$DRY_RUN" == "false" ]]; then
        $KUBECTL rollout undo "deployment/$DEPLOYMENT"
    fi
}

DEBUG=$(jq -r .source.debug < "$payload")
[[ "$DEBUG" == "true" ]] && { echo "Enabling debug mode.";set -x; }

cd "$1"

ls /root/.kube 2>/dev/null || echo '/root/.kube does not exist'
mkdir -p /root/.kube

KUBE_URL=$(jq -r .source.cluster_url < "$payload")
NAMESPACE=$(jq -r .source.namespace < "$payload")

KUBECTL="/usr/local/bin/kubectl --server=$KUBE_URL --namespace=$NAMESPACE"

# configure SSL Certs if available
if [[ "$KUBE_URL" =~ https.* ]]; then
    KUBE_CA=$(jq -r .source.cluster_ca < "$payload")
    KUBE_KEY=$(jq -r .source.admin_key < "$payload")
    KUBE_CERT=$(jq -r .source.admin_cert < "$payload")
    CA_PATH="/root/.kube/ca.pem"
    KEY_PATH="/root/.kube/key.pem"
    CERT_PATH="/root/.kube/cert.pem"

    echo "$KUBE_CA" | base64 -d > $CA_PATH
    echo "$KUBE_KEY" | base64 -d > $KEY_PATH
    echo "$KUBE_CERT" | base64 -d > $CERT_PATH

    KUBECTL="$KUBECTL --certificate-authority=$CA_PATH --client-key=$KEY_PATH --client-certificate=$CERT_PATH"
fi

export KUBECTL
DEPLOYMENT_LIST=$(jq -r .source.deployment_list< "$payload")
SANITIZED_DEPLOYMENT_LIST=`echo $DEPLOYMENT_LIST | sed -e 's,\,,,g' | sed -e 's,\[,,g' | sed -e 's,\],,g' | sed -e 's,\",,g'`
DEPLOYMENT_ARRAY=($SANITIZED_DEPLOYMENT_LIST)

ROLLBACK=$(jq -r .params.rollback < "$payload")
if [[ "$ROLLBACK" == "true" ]]; then
    echo "********************** Method invoked: Rollback **********************"
fi

if [[ "$ROLLBACK" = "true" ]]; then
    for deployment_name in "${DEPLOYMENT_ARRAY[@]}"; do
        rollback $deployment_name "$DRY_RUN";
    done
fi

result="$(jq -n "{version:{container:\"$IMG\"}}")"
echo "Out complete"
echo "$result" | jq -s add  >&3
